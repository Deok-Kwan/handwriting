# Multiple Instance Learning 기반 다중 작성자 필기 문서 탐지 연구

## 1. 연구 배경 및 동기

### 1.1 문제의 중요성

현대 사회에서 문서의 진위 판별은 법의학, 역사학, 그리고 다양한 법적 분쟁 해결에 있어 핵심적인 역할을 합니다. 특히 유언장, 계약서, 역사적 문서 등에서 문서가 단일 작성자에 의해 작성되었는지, 아니면 여러 작성자가 관여했는지를 판별하는 것은 매우 중요한 문제입니다. 

전통적으로 이러한 판별은 필기 전문가의 주관적 판단에 의존해왔으나, 이는 시간과 비용이 많이 들고, 전문가 간 의견 차이가 발생할 수 있다는 한계가 있습니다. 따라서 객관적이고 자동화된 AI 기반 판별 시스템의 필요성이 대두되고 있습니다.

### 1.2 기존 접근법의 한계

기존의 필기 인식 및 작성자 식별 연구들은 주로 개별 문자나 단어, 또는 작은 텍스트 패치 단위로 분석을 수행합니다. 이러한 접근법은 다음과 같은 한계를 가집니다:

1. **부분적 분석의 한계**: 문서의 일부분만을 보고 전체 문서의 작성자를 판단하기 어려움
2. **컨텍스트 무시**: 문서 전체의 일관성이나 패턴 변화를 포착하지 못함
3. **레이블링 비용**: 모든 패치에 대해 작성자 레이블을 지정하는 것은 비현실적

### 1.3 Multiple Instance Learning (MIL)의 도입

이러한 한계를 극복하기 위해 본 연구에서는 Multiple Instance Learning (MIL) 프레임워크를 도입했습니다. MIL은 다음과 같은 특징을 가집니다:

- **Bag**: 문서 전체 (여러 패치의 집합)
- **Instance**: 문서 내 개별 필기 패치
- **Label**: Bag 수준에서만 제공 (단일 작성자: False, 복수 작성자: True)

이 접근법의 핵심은 개별 패치의 레이블을 알 필요 없이, 문서 전체 수준에서의 판별이 가능하다는 점입니다.

## 2. 연구 방법론

### 2.1 데이터 구성

#### 2.1.1 원본 데이터
- **데이터셋**: 300명 작성자의 한글 필기 이미지 (CSAFE 데이터셋)
- **이미지 크기**: 다양한 크기의 필기 이미지
- **전처리**: 224x224 픽셀로 리사이즈, Grayscale → RGB 변환

#### 2.1.2 실험 데이터 구성
- **사용 작성자**: 100명 (라벨 200-299)
- **데이터 분할**:
  - 훈련: 60명 (200-259)
  - 검증: 20명 (260-279)
  - 테스트: 20명 (280-299)

#### 2.1.3 합성 데이터 생성
MIL 학습을 위해 다음과 같은 방식으로 Bag을 생성:
- **False Bag (단일 작성자)**: 한 작성자의 여러 패치로 구성
- **True Bag (복수 작성자)**: False Bag에서 1-2개 패치를 다른 작성자의 패치로 교체

### 2.2 Phase 1: Autoencoder 기반 접근 (실패)

#### 2.2.1 접근 방식
첫 번째 시도로 Autoencoder를 사용하여 필기 특징을 추출하려 했습니다:

1. **아키텍처**:
   ```
   Input (224x224x3) → ViT Encoder (300d) → Bottleneck (128d) → Decoder → Reconstructed Output
   ```

2. **학습 목표**: 재구성 오류(MSE) 최소화
3. **가정**: 압축된 128차원 특징이 작성자 특성을 포함할 것

#### 2.2.2 실험 과정
1. Autoencoder를 단일 작성자 데이터로 학습
2. 학습된 Encoder를 사용하여 모든 패치의 128차원 임베딩 추출
3. MIL 모델(Attention-Based)로 Bag 수준 분류 수행

#### 2.2.3 결과 및 분석
- **정확도**: 50.2% (사실상 랜덤 추측 수준)
- **문제점**: 
  - Autoencoder는 이미지 재구성에 최적화되어 있어, 작성자 구분에 필요한 미묘한 스타일 차이를 학습하지 못함
  - 재구성 목적과 작성자 식별 목적 간의 근본적인 불일치

### 2.3 Phase 2: Siamese Network 기반 접근 (진행 중)

#### 2.3.1 Siamese Network의 도입 배경
Autoencoder의 한계를 극복하기 위해, 유사도 학습에 특화된 Siamese Network를 도입했습니다:

1. **핵심 아이디어**: 같은 작성자의 패치는 가깝게, 다른 작성자의 패치는 멀게 배치
2. **장점**: 작성자 구분이라는 목적에 직접적으로 부합하는 학습 방식

#### 2.3.2 모델 아키텍처
```python
class SiameseNetwork(nn.Module):
    def __init__(self, base_model, embedding_dim=128):
        super(SiameseNetwork, self).__init__()
        self.base_model = base_model  # 사전학습된 ViT
        self.embedding_layer = nn.Sequential(
            nn.Linear(300, 256),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(256, embedding_dim),
            nn.BatchNorm1d(embedding_dim)
        )
    
    def forward_one(self, x):
        x = self.base_model(x)
        x = self.embedding_layer(x)
        return F.normalize(x, p=2, dim=1)  # L2 정규화
```

#### 2.3.3 학습 데이터 구성
- **Positive Pair**: 같은 작성자의 서로 다른 패치
- **Negative Pair**: 다른 작성자의 패치
- **손실 함수**: Contrastive Loss
  ```
  L = (1-Y) * 0.5 * D^2 + Y * 0.5 * max(0, margin - D)^2
  ```
  여기서 Y=0은 같은 작성자, Y=1은 다른 작성자, D는 유클리디안 거리

### 2.4 실험 1: 기본 Siamese Network

#### 2.4.1 실험 설정
- **Margin**: 1.0
- **Learning Rate**: 1e-3
- **Optimizer**: Adam
- **Batch Size**: 64
- **Epochs**: 50 (Early Stopping 적용)

#### 2.4.2 결과
- **정확도**: 64.4%
- **성능 향상**: Autoencoder 대비 14.2%p 향상
- **거리 분포**:
  - 같은 작성자 평균 거리: 0.8
  - 다른 작성자 평균 거리: 1.2
  - 분포 간 겹침 존재

#### 2.4.3 분석
- Siamese Network가 작성자 특징을 어느 정도 학습하고 있음을 확인
- 하지만 여전히 목표 성능(70%)에는 미달
- 거리 분포의 겹침이 크다는 것이 주요 문제점

### 2.5 실험 2: 개선된 Siamese Network (임베딩 붕괴)

#### 2.5.1 개선 시도
성능 향상을 위해 다음과 같은 개선을 시도:

1. **Margin 조정**: 0.5로 변경 (실제로는 감소)
2. **Mixed Precision Training**: 메모리 효율성 향상
3. **데이터셋 버그 수정**: 동일 이미지가 pair로 들어가는 문제 해결
4. **최적 임계값 자동 탐색**: ROC 곡선 기반 최적 threshold 계산

#### 2.5.2 예상치 못한 결과
- **정확도**: 56.5% (오히려 7.9%p 하락)
- **F1-Score**: 63.8%
- **AUC**: 0.586
- **최적 임계값**: 4.16e-05 (극도로 작은 값)

#### 2.5.3 임베딩 붕괴 현상

**현상**:
- 모든 샘플의 임베딩이 거의 동일한 값으로 수렴
- 모든 거리가 0에 가까운 값으로 집중
- t-SNE 시각화에서 모든 점이 하나로 뭉침

**원인 분석**:
1. **Margin 값 문제**: 
   - 128차원 정규화 공간에서 0.5는 여전히 큰 값일 수 있음
   - 모델이 모든 샘플을 가깝게 만드는 것이 손실을 줄이는 쉬운 방법

2. **학습 불안정성**:
   - 8번째 에폭에서 NaN loss 발생
   - Gradient explosion 가능성

3. **데이터 불균형**:
   - Negative pair가 Positive pair보다 훨씬 많음
   - 불균형한 학습 신호

## 3. 문제 해결 방안

### 3.1 단기 해결책 (1-2주)

#### 3.1.1 Margin 값 최적화
- Grid Search를 통한 체계적인 탐색 (0.1 ~ 0.5)
- 정규화된 공간의 특성을 고려한 값 선택

#### 3.1.2 학습 안정화
- Learning rate 감소: 1e-3 → 1e-4
- Gradient clipping 적용
- Warmup scheduler 도입

#### 3.1.3 데이터 균형
- Balanced batch sampling
- Positive/Negative 비율 1:1 유지

### 3.2 중장기 개선안

#### 3.2.1 Triplet Loss 도입
```
L = max(0, d(a,p) - d(a,n) + margin)
```
- Anchor-Positive-Negative 삼중항 사용
- 임베딩 붕괴에 더 강건한 구조

#### 3.2.2 Hard Mining
- Semi-hard negative mining
- 학습이 어려운 샘플 위주로 선택

#### 3.2.3 고급 Metric Learning
- ArcFace: 각도 기반 margin loss
- CosFace: Cosine similarity 기반 접근

## 4. 연구의 의의 및 기대 효과

### 4.1 학술적 기여
1. **MIL 프레임워크의 새로운 적용**: 필기 분석 분야에 MIL 적용
2. **임베딩 붕괴 현상 분석**: Metric learning의 실패 사례 연구
3. **체계적인 해결 방안 제시**: 단계별 개선 전략

### 4.2 실용적 가치
1. **법의학 응용**: 문서 위조 탐지 자동화
2. **역사 문서 분석**: 저자 진위 판별
3. **계약서 검증**: 서명 및 필기 일관성 확인

### 4.3 향후 발전 방향
1. **다국어 확장**: 한글 외 다른 언어로 확장
2. **실시간 처리**: 온라인 문서 검증 시스템
3. **설명가능한 AI**: 판별 근거 시각화

## 5. 현재 진행 상황 요약

본 연구는 현재 Siamese Network의 임베딩 붕괴 문제를 해결하는 단계에 있습니다. 초기 실험에서 64.4%의 유망한 결과를 얻었으나, 성능 개선 시도 중 예상치 못한 기술적 문제에 직면했습니다. 

하지만 이는 단순한 실패가 아니라, metric learning의 민감성과 하이퍼파라미터 튜닝의 중요성을 깊이 이해하는 계기가 되었습니다. 명확한 원인 분석과 구체적인 해결 방안을 바탕으로, 목표 성능인 70% 이상을 달성할 수 있을 것으로 기대합니다.

연구의 핵심은 "실패를 통한 학습"입니다. 각 실험의 결과, 성공이든 실패든, 모두 최종 목표 달성을 위한 중요한 디딤돌이 되고 있습니다.